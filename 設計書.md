# EC 在庫管理最適化ツール 設計書

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌─────────────────┐
│   Web Browser   │
│  (Next.js App)  │
└────────┬────────┘
         │
         │ HTTP/HTTPS
         │
┌────────▼────────┐
│   Next.js       │
│   (Full Stack)  │
│                 │
│  ┌───────────┐  │
│  │ Frontend  │  │
│  │ (React)   │  │
│  └───────────┘  │
│  ┌───────────┐  │
│  │ Backend   │  │
│  │ (API)     │  │
│  └───────────┘  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│PostgreSQL│ │Shopify│
│Database │ │  API  │
└─────────┘ └───────┘
```

### 1.2 技術スタック

- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript
- **UI**: Tailwind CSS + shadcn/ui
- **データベース**: PostgreSQL
- **ORM**: Prisma
- **認証**: NextAuth.js v5 (Auth.js)
- **状態管理**: Zustand
- **HTTP クライアント**: fetch API (Next.js 組み込み)
- **日付処理**: date-fns

## 2. データベース設計

### 2.1 ER 図（主要エンティティ）

```
User ──┐
       │
       ├── Product ──┬── Inventory
       │             │
       │             ├── SalesHistory
       │             │
       │             ├── InventoryHistory
       │             │
       │             └── PurchaseOrder ─── Supplier
       │
       └── AlertSetting
```

### 2.2 テーブル定義

#### 2.2.1 users（ユーザー）

| カラム名      | 型           | 制約             | 説明               |
| ------------- | ------------ | ---------------- | ------------------ |
| id            | UUID         | PK               | ユーザー ID        |
| email         | VARCHAR(255) | UNIQUE, NOT NULL | メールアドレス     |
| password_hash | VARCHAR(255) | NOT NULL         | パスワードハッシュ |
| name          | VARCHAR(255) |                  | ユーザー名         |
| created_at    | TIMESTAMP    | NOT NULL         | 作成日時           |
| updated_at    | TIMESTAMP    | NOT NULL         | 更新日時           |

#### 2.2.2 products（商品）

| カラム名               | 型            | 制約              | 説明                       |
| ---------------------- | ------------- | ----------------- | -------------------------- |
| id                     | UUID          | PK                | 商品 ID                    |
| sku                    | VARCHAR(100)  | UNIQUE, NOT NULL  | SKU コード                 |
| name                   | VARCHAR(255)  | NOT NULL          | 商品名                     |
| category               | VARCHAR(100)  |                   | カテゴリ                   |
| purchase_price         | DECIMAL(10,2) |                   | 仕入価格                   |
| selling_price          | DECIMAL(10,2) |                   | 販売価格                   |
| predicted_weekly_sales | INTEGER       | DEFAULT 0         | 週次予測販売数（新商品用） |
| supplier_id            | UUID          | FK → suppliers.id | 発注先 ID                  |
| shopify_product_id     | BIGINT        | UNIQUE            | Shopify 商品 ID            |
| shopify_variant_id     | BIGINT        |                   | Shopify バリアント ID      |
| created_at             | TIMESTAMP     | NOT NULL          | 作成日時                   |
| updated_at             | TIMESTAMP     | NOT NULL          | 更新日時                   |

#### 2.2.3 inventory（在庫）

| カラム名         | 型        | 制約                     | 説明                 |
| ---------------- | --------- | ------------------------ | -------------------- |
| id               | UUID      | PK                       | 在庫 ID              |
| product_id       | UUID      | FK → products.id, UNIQUE | 商品 ID              |
| current_quantity | INTEGER   | NOT NULL, DEFAULT 0      | 現在在庫数           |
| last_synced_at   | TIMESTAMP |                          | Shopify 最終同期日時 |
| created_at       | TIMESTAMP | NOT NULL                 | 作成日時             |
| updated_at       | TIMESTAMP | NOT NULL                 | 更新日時             |

#### 2.2.4 sales_history（販売履歴）

| カラム名         | 型        | 制約             | 説明            |
| ---------------- | --------- | ---------------- | --------------- |
| id               | UUID      | PK               | 販売履歴 ID     |
| product_id       | UUID      | FK → products.id | 商品 ID         |
| sold_date        | DATE      | NOT NULL         | 販売日          |
| sold_quantity    | INTEGER   | NOT NULL         | 販売数量        |
| shopify_order_id | BIGINT    |                  | Shopify 注文 ID |
| created_at       | TIMESTAMP | NOT NULL         | 作成日時        |

**インデックス**: (product_id, sold_date)

#### 2.2.5 inventory_history（在庫履歴）

| カラム名          | 型          | 制約             | 説明                            |
| ----------------- | ----------- | ---------------- | ------------------------------- |
| id                | UUID        | PK               | 在庫履歴 ID                     |
| product_id        | UUID        | FK → products.id | 商品 ID                         |
| change_date       | TIMESTAMP   | NOT NULL         | 変動日時                        |
| previous_quantity | INTEGER     | NOT NULL         | 変動前在庫数                    |
| new_quantity      | INTEGER     | NOT NULL         | 変動後在庫数                    |
| change_type       | VARCHAR(50) | NOT NULL         | 変動種別（入荷/出荷/調整/同期） |
| notes             | TEXT        |                  | 備考                            |
| created_at        | TIMESTAMP   | NOT NULL         | 作成日時                        |

**インデックス**: (product_id, change_date)

#### 2.2.6 suppliers（発注先）

| カラム名       | 型           | 制約     | 説明           |
| -------------- | ------------ | -------- | -------------- |
| id             | UUID         | PK       | 発注先 ID      |
| name           | VARCHAR(255) | NOT NULL | 発注先名       |
| contact_person | VARCHAR(255) |          | 担当者名       |
| email          | VARCHAR(255) |          | メールアドレス |
| phone          | VARCHAR(50)  |          | 電話番号       |
| address        | TEXT         |          | 住所           |
| created_at     | TIMESTAMP    | NOT NULL | 作成日時       |
| updated_at     | TIMESTAMP    | NOT NULL | 更新日時       |

#### 2.2.7 purchase_orders（発注）

| カラム名               | 型            | 制約              | 説明                                       |
| ---------------------- | ------------- | ----------------- | ------------------------------------------ |
| id                     | UUID          | PK                | 発注 ID                                    |
| supplier_id            | UUID          | FK → suppliers.id | 発注先 ID                                  |
| product_id             | UUID          | FK → products.id  | 商品 ID                                    |
| order_date             | DATE          | NOT NULL          | 発注日                                     |
| quantity               | INTEGER       | NOT NULL          | 発注数量                                   |
| unit_price             | DECIMAL(10,2) |                   | 単価                                       |
| status                 | VARCHAR(50)   | NOT NULL          | ステータス（発注済み/入荷済み/キャンセル） |
| expected_delivery_date | DATE          |                   | 入荷予定日                                 |
| actual_delivery_date   | DATE          |                   | 入荷日                                     |
| notes                  | TEXT          |                   | 備考                                       |
| created_at             | TIMESTAMP     | NOT NULL          | 作成日時                                   |
| updated_at             | TIMESTAMP     | NOT NULL          | 更新日時                                   |

**インデックス**: (supplier_id, order_date), (product_id, order_date)

#### 2.2.8 alert_settings（アラート設定）

| カラム名              | 型           | 制約                | 説明                 |
| --------------------- | ------------ | ------------------- | -------------------- |
| id                    | UUID         | PK                  | 設定 ID              |
| user_id               | UUID         | FK → users.id       | ユーザー ID          |
| alert_threshold_weeks | INTEGER      | NOT NULL, DEFAULT 2 | アラート基準週数     |
| email_notification    | BOOLEAN      | DEFAULT false       | メール通知有効       |
| email_address         | VARCHAR(255) |                     | 通知先メールアドレス |
| line_notification     | BOOLEAN      | DEFAULT false       | LINE 通知有効        |
| line_webhook_url      | VARCHAR(500) |                     | LINE Webhook URL     |
| slack_notification    | BOOLEAN      | DEFAULT false       | Slack 通知有効       |
| slack_webhook_url     | VARCHAR(500) |                     | Slack Webhook URL    |
| created_at            | TIMESTAMP    | NOT NULL            | 作成日時             |
| updated_at            | TIMESTAMP    | NOT NULL            | 更新日時             |

#### 2.2.9 shopify_settings（Shopify 設定）

| カラム名       | 型           | 制約          | 説明                           |
| -------------- | ------------ | ------------- | ------------------------------ |
| id             | UUID         | PK            | 設定 ID                        |
| user_id        | UUID         | FK → users.id | ユーザー ID                    |
| store_name     | VARCHAR(255) | NOT NULL      | ストア名                       |
| api_key        | VARCHAR(255) | NOT NULL      | API キー（暗号化保存）         |
| api_secret     | VARCHAR(255) | NOT NULL      | API シークレット（暗号化保存） |
| access_token   | TEXT         |               | アクセストークン（暗号化保存） |
| webhook_secret | VARCHAR(255) |               | Webhook シークレット           |
| sync_enabled   | BOOLEAN      | DEFAULT true  | 同期有効                       |
| last_sync_at   | TIMESTAMP    |               | 最終同期日時                   |
| created_at     | TIMESTAMP    | NOT NULL      | 作成日時                       |
| updated_at     | TIMESTAMP    | NOT NULL      | 更新日時                       |

## 3. API 設計

### 3.1 認証 API

- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/session` - セッション取得

### 3.2 商品 API

- `GET /api/products` - 商品一覧取得（検索・フィルタ対応）
- `GET /api/products/:id` - 商品詳細取得
- `POST /api/products` - 商品作成
- `PUT /api/products/:id` - 商品更新
- `DELETE /api/products/:id` - 商品削除
- `GET /api/products/:id/weeks-until-out` - 在庫切れまでの週数取得

### 3.3 在庫 API

- `GET /api/inventory` - 在庫一覧取得
- `GET /api/inventory/:productId` - 商品在庫取得
- `PUT /api/inventory/:productId` - 在庫数更新（手動調整用）
- `GET /api/inventory/:productId/history` - 在庫履歴取得

### 3.4 アラート API

- `GET /api/alerts` - アラート商品一覧取得
- `GET /api/alerts/count` - アラート件数取得

### 3.5 発注 API

- `GET /api/purchase-orders` - 発注一覧取得
- `GET /api/purchase-orders/:id` - 発注詳細取得
- `POST /api/purchase-orders` - 発注作成
- `PUT /api/purchase-orders/:id` - 発注更新
- `GET /api/suppliers` - 発注先一覧取得
- `POST /api/suppliers` - 発注先作成
- `PUT /api/suppliers/:id` - 発注先更新
- `DELETE /api/suppliers/:id` - 発注先削除

### 3.6 Shopify 連携 API

- `POST /api/shopify/sync` - 手動同期実行
- `GET /api/shopify/settings` - Shopify 設定取得
- `POST /api/shopify/settings` - Shopify 設定保存
- `POST /api/shopify/test-connection` - 接続テスト

### 3.7 設定 API

- `GET /api/settings/alerts` - アラート設定取得
- `PUT /api/settings/alerts` - アラート設定更新

### 3.8 ダッシュボード API

- `GET /api/dashboard/summary` - ダッシュボードサマリー取得

## 4. 画面設計

### 4.1 画面一覧

1. **ログイン画面** (`/login`)

   - メールアドレス・パスワード入力
   - ログインボタン

2. **ダッシュボード** (`/`)

   - アラート商品一覧（上位 10 件）
   - 在庫状況サマリー（総商品数、アラート件数、低在庫商品数）
   - 最近の発注履歴

3. **商品一覧** (`/products`)

   - 商品一覧テーブル（在庫切れまでの週数表示）
   - 検索・フィルタ機能
   - 新規登録ボタン
   - アラート商品のハイライト表示

4. **商品詳細** (`/products/:id`)

   - 商品基本情報
   - 現在在庫数
   - 在庫切れまでの週数
   - 在庫履歴グラフ
   - 販売実績グラフ（直近 4 週間）
   - 編集・削除ボタン

5. **在庫管理** (`/inventory`)

   - 在庫一覧
   - 手動調整機能

6. **発注管理** (`/purchase-orders`)

   - 発注一覧
   - 新規発注ボタン
   - フィルタ（ステータス、発注先）

7. **発注先管理** (`/suppliers`)

   - 発注先一覧
   - 新規登録・編集・削除

8. **設定** (`/settings`)
   - Shopify 連携設定
   - アラート設定（基準週数、通知先）

### 4.2 UI コンポーネント設計

- **Layout**: サイドバー + メインコンテンツ
- **Table**: 商品一覧、在庫一覧、発注一覧
- **Card**: ダッシュボードのサマリーカード
- **Alert Badge**: アラート商品の表示
- **Chart**: 在庫履歴・販売実績のグラフ表示

## 5. ビジネスロジック

### 5.1 在庫切れまでの週数算出

```typescript
function calculateWeeksUntilOut(
  currentQuantity: number,
  productId: string,
  salesHistory: SalesHistory[]
): number {
  // 直近1週間の販売数を取得
  const oneWeekAgo = subDays(new Date(), 7);
  const recentSales = salesHistory.filter(
    (sale) => sale.sold_date >= oneWeekAgo
  );

  const weeklySales = recentSales.reduce(
    (sum, sale) => sum + sale.sold_quantity,
    0
  );

  // 販売実績がない場合は予測値を使用
  if (weeklySales === 0) {
    const product = getProduct(productId);
    weeklySales = product.predicted_weekly_sales || 1; // デフォルト1
  }

  if (weeklySales === 0) {
    return Infinity; // 販売がない場合は無限大
  }

  return currentQuantity / weeklySales;
}
```

### 5.2 アラート判定

```typescript
function checkAlert(weeksUntilOut: number, threshold: number = 2): boolean {
  return weeksUntilOut < threshold;
}
```

### 5.3 Shopify 同期ロジック

1. Shopify API から商品一覧を取得
2. 各商品の在庫数を取得
3. データベースの在庫数を更新
4. 在庫履歴を記録
5. 販売履歴を取得して更新

## 6. セキュリティ設計

### 6.1 認証・認可

- NextAuth.js によるセッション管理
- パスワードは bcrypt でハッシュ化
- API ルートは認証ミドルウェアで保護

### 6.2 データ保護

- Shopify API 認証情報は暗号化して保存
- 環境変数で機密情報を管理
- SQL インジェクション対策（Prisma 使用）

### 6.3 入力検証

- すべての入力データをバリデーション
- Zod スキーマによる型安全な検証

## 7. パフォーマンス最適化

### 7.1 データベース

- 適切なインデックス設定
- ページネーション実装
- クエリの最適化

### 7.2 フロントエンド

- Next.js の Server Components 活用
- 必要に応じてクライアントサイドキャッシュ
- 画像最適化

### 7.3 バックエンド

- Shopify API 呼び出しの最適化
- バッチ処理による同期
- エラーハンドリングとリトライロジック

## 8. エラーハンドリング

### 8.1 エラー分類

- **認証エラー**: 401 Unauthorized
- **権限エラー**: 403 Forbidden
- **リソース不存在**: 404 Not Found
- **バリデーションエラー**: 400 Bad Request
- **サーバーエラー**: 500 Internal Server Error

### 8.2 エラーログ

- サーバーエラーはログに記録
- ユーザーには適切なエラーメッセージを表示

## 9. テスト戦略

### 9.1 単体テスト

- ビジネスロジック（週数算出など）
- ユーティリティ関数

### 9.2 統合テスト

- API エンドポイント
- データベース操作

### 9.3 E2E テスト

- 主要なユーザーフロー
- 認証フロー
